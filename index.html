<!doctype html>
<html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" href="bootstrap/css/bootstrap.css">
<link rel="stylesheet" href="awesome/css/font-awesome.css">
<link rel="stylesheet" href="style/main.css">
<script src="script/$.js"></script>
<script src="bootstrap/js/bootstrap.js"></script>
<script src="node_modules/underscore/underscore.js"></script>
<script src="node_modules/underscore.string/dist/underscore.string.min.js"></script>
<script>
_.mixin(_.str.exports());
</script>
<script src="script/queue.js"></script>
<script src="script/urlbar.js"></script>
<script>
phiQ = queue();
JAM = require('fidonet-jam');

beforeSpace = function(inString){
   if( inString.indexOf(' ') === -1 ){
      return inString;
   }
   return _(inString).strLeft(' ');
};
</script>
<title>PhiDo</title>
<script>
$(function(){
var simteconf = require('simteconf');
var phiConf = simteconf('phido.conf', {
   skipNames: ['//', '#']
});
// Read GoldED settings:
var encodingGED = phiConf.last('EncodingGoldED') || 'utf8';
var confGED = simteconf(phiConf.last('ConfigGoldED'), {
   encoding: encodingGED,
   skipNames: ['//', '#', '-'+'-']
});
var UserName = phiConf.first('UserName') || confGED.first('UserName') || 'anonymous';
// Read HPT areas:
var encodingHPT = phiConf.last('EncodingHPT') || 'utf8';
var areas = simteconf(phiConf.last('AreasHPT'), {
   encoding: encodingHPT,
   skipNames: ['#'],
   lowercase: false,
   prefixGroups: [
      'NetmailArea',
      'BadArea',
      'DupeArea',
      'LocalArea',
      'EchoArea'
   ]
});
$('center').html(
   'Welcome, <i class="fa fa-user"></i><b>'+UserName+'!</b>'
);
var echoNames = areas.group('EchoArea').names();
if( echoNames.length > 0 ){
   $('center').after('<table id="areaList" class="table table-bordered table-hover table-condensed">' +
   '<tr class="inverse">' +
      '<th>Area title</th>' +
      '<th style="text-align: center;">Msgs</th>' +
      '<th>Echotag</th>' +
   '</tr></table>');
   echoNames = _(echoNames).sortBy(function(value){ // stable sort
      return value.toLowerCase();
   });
   _(echoNames).each(function(echoName){
      var arrDesc = /-d "([^"]+?)"/.exec( areas.group('EchoArea').first(echoName) );
      var echoDesc;
      if( arrDesc === null ){
         echoDesc = echoName;
      } else {
         echoDesc = arrDesc[1];
      }
      $('<tr>' +
         '<td>'+_.escapeHTML(echoDesc)+'</td>' +
         '<td class="msgnum"><i class="fa fa-spinner fa-spin"></i></td>' +
         '<td>'+_.escapeHTML(echoName)+'</td>' +
      '</tr>').appendTo('#areaList tbody').find('.msgnum').data({
         'echopath': beforeSpace( areas.group('EchoArea').first(echoName) )
      });
   });
   $('#areaList .msgnum').each(function(idx){
      var $cell = $(this);
      phiQ.push(function(){
         var echobase = JAM( $cell.data('echopath') );
         echobase.readJDX(function(err){
            if( err ){
               $cell.html('FAIL');
               phiQ.singleNext();
               return;
            }
            $cell.html( echobase.size() );
            phiQ.singleNext();
         });
      });
   });
   phiQ.singleStep();
}
});
</script>
</head>
<body>
<div class="container">
<div class="row"><div class="col-xs-12">
<div id="urlbar" style="display: flex; flex-direction: row;">
<button type="button" class="form-control btn btn-default" style="width: 50px; flex-grow: 0;"
disabled><i class="fa fa-arrow-left"></i></button>
<button type="button" class="form-control btn btn-default" style="width: 50px; flex-grow: 0;"
disabled><i class="fa fa-arrow-right"></i></button>
<input type="text" class="form-control" style="flex-grow: 1;"
placeholder="Enter FGHI URL here" value="area://">
<button type="submit" class="form-control btn btn-default" style="width: 50px; flex-grow: 0;"><i
class="fa fa-play"
></i></button>
<button type="button" class="form-control btn btn-default" style="width: 50px; flex-grow: 0;"><img
src="icon/PhiDo-16x16.png"
></button>
</div>
</div></div>
<center><img src="img/loading.gif"><br>
loading configurationâ€¦</center>
</div></body>
</html>